<script src="../../bower_components/gif.js/dist/gif.js"></script>
<dom-module id="kano-gif-creator">
    <style>
        :host {
            display: block;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
    </style>
    <template>
        <canvas id="canvas" width$="[[width]]" height$="[[height]]"></canvas>
    </template>
    <script>
        Polymer({
            is: 'kano-gif-creator',
            properties: {
                pictures: {
                    type: Array,
                    value: () => {
                        return [];
                    }
                },
                framerate: {
                    type: Number,
                    value: 15
                },
                width: {
                    type: Number
                },
                height: {
                    type: Number
                }
            },
            observers: [
                '_picturesChanged(pictures.splices)'
            ],
            ready () {
                this.frameId = 0;
                this.ctx = this.$.canvas.getContext('2d');
            },
            _picturesChanged () {
                this._paintFrame(this.pictures[this.pictures.length - 1]);
            },
            _updateFrame () {
                this.frameId++;
                if (this.frameId >= this.pictures.length) {
                    this.frameId = 0;
                }
                this.frame = this.pictures[this.frameId];
                this._paintFrame(this.frame);
                this.timeoutId = setTimeout(this._updateFrame.bind(this), 1000 / this.framerate);
            },
            play () {
                this._updateFrame();
            },
            pause () {
                clearInterval(this.timeoutId);
            },
            _paintFrame (src) {
                let img = new Image(),
                    width = this.$.canvas.width,
                    height = this.$.canvas.height,
                    finalHeight,
                    heightDiff;
                img.onload = () => {
                    finalHeight = width * (img.naturalHeight / img.naturalWidth);
                    heightDiff = height - finalHeight;
                    this.ctx.clearRect(0, 0, width, height);
                    this.ctx.drawImage(img, 0, heightDiff / 2, width, finalHeight);
                };
                img.src = src;
            },
            _createGif () {
                let gif = new GIF({
                    workers: 2,
                    quality: 10,
                    workerScript: '/scripts/workers/gif.worker.js'
                }),
                    promises;
                promises = this.pictures.map((url) => {
                    return new Promise((resolve, reject) => {
                        let img = new Image();
                        img.crossOrigin = 'Anonymous';
                        img.onload = () => {
                            resolve(img);
                        };
                        img.onerror = (e) => {
                            reject(e);
                        };
                        img.src = url;
                    });
                });
                return Promise.all(promises).then(images => {
                    return new Promise((resolve, reject) => {
                        images.forEach((image) => {
                            gif.addFrame(image, { delay: 1000 / this.framerate });
                        });
                        gif.on('finished', (blob) => {
                            resolve(blob);
                        });
                        gif.render();
                    });
                });
            },
            downloadGif () {
                this._createGif().then(blob => {
                    let a = document.createElement('a'),
                        url;
                    a.style.display = 'none';
                    url = URL.createObjectURL(blob);
                    a.href = url;
                    a.download = 'my-gif.gif';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
        });
    </script>
</dom-module>
