(function () {    
    'use strict';

    const pixel_font_letters = {
        'A': [
            [, 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, 1, 1],
            [1, , 1],
            [1, , 1],
            [1, , 1]
        ],
        'B': [
            [1, 1, ],
            [1, , 1],
            [1, , 1],
            [1, 1, ],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, 1, 1]
        ],
        'C': [
            [, 1, 1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [, 1, 1]
        ],
        'D': [
            [1, 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, 1]
        ],
        'E': [
            [1, 1, 1],
            [1],
            [1],
            [1, 1, 1],
            [1],
            [1],
            [1],
            [1, 1, 1]
        ],
        'F': [
            [1, 1, 1],
            [1],
            [1],
            [1, 1],
            [1],
            [1],
            [1],
            [1]
        ],
        'G': [
            [, 1, 1],
            [1],
            [1],
            [1],
            [1],
            [1, , 1, 1],
            [1, , , 1],
            [, 1, 1]
        ],
        'H': [
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, 1, 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, , 1]
        ],
        'I': [
            [1, 1, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [1, 1, 1]
        ],
        'J': [
            [, , 1],
            [, , 1],
            [, , 1],
            [, , 1],
            [, , 1],
            [, , 1],
            [1, , 1],
            [1, 1, 1]
        ],
        'K': [
            [1, , , 1],
            [1, , , 1],
            [1, , 1],
            [1, 1, ],
            [1, , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1]
        ],
        'L': [
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1, 1, 1]
        ],
        'M': [
            [1, , , , 1],
            [1, 1, , 1, 1],
            [1, , 1, , 1],
            [1, , 1, , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1]
        ],
        'N': [
            [1, , , 1],
            [1, , , 1],
            [1, 1, , 1],
            [1, , 1, 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1]
        ],
        'O': [
            [, 1, 1, ],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [, 1, 1, ]
        ],
        'P': [
            [1, 1, ],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, 1, ],
            [1],
            [1],
            [1]
        ],
        'Q': [
            [0, 1, 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , 1, ],
            [, 1, , 1]
        ],
        'R': [
            [1, 1],
            [1, , 1],
            [1, , 1],
            [1, , 1],
            [1, 1],
            [1, , 1],
            [1, , 1],
            [1, , 1]
        ],
        'S': [
            [, 1, 1],
            [1],
            [1],
            [, 1, ],
            [, , 1],
            [, , 1],
            [1, , 1],
            [, 1, ]
        ],
        'T': [
            [1, 1, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1]
        ],
        'U': [
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [1, , , 1],
            [, 1, 1]
        ],
        'V': [
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [, 1, , 1],
            [, 1, , 1],
            [, , 1]
        ],
        'W': [
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , 1, , 1],
            [1, , 1, , 1],
            [1, 1, , 1, 1],
            [1, , , , 1]
        ],
        'X': [
            [1, , , , 1],
            [1, , , , 1],
            [, 1, , 1],
            [, , 1],
            [, 1, , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1]
        ],
        'Y': [
            [1, , , , 1],
            [1, , , , 1],
            [, 1, , 1],
            [, , 1],
            [, , 1],
            [, , 1],
            [, , 1],
            [, , 1]
        ],
        'Z': [
            [1, 1, 1, 1, 1],
            [, , , , 1],
            [, , , 1],
            [, , 1],
            [, 1],
            [1],
            [1],
            [1, 1, 1, 1, 1]
        ],
        '0': [
            [, 1, 1, 1, ],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [, 1, 1, 1, ]
        ],
        '1': [
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1]
        ],
        '2': [
            [, 1, 1, 1],
            [1, , , , 1],
            [, , , , 1],
            [, , , 1],
            [, , 1],
            [, 1],
            [1],
            [1, 1, 1, 1, 1]
        ],
        '3': [
            [, 1, 1, 1],
            [1, , , ,1],
            [, , , 1],
            [, , 1],
            [, , , 1],
            [, , , , 1],
            [1, , , , 1],
            [, 1, 1, 1]
        ],
        '4': [
            [1],
            [1],
            [1],
            [1, , , 1],
            [1, , , 1],
            [1, 1, 1, 1, 1],
            [, , , 1],
            [, , , 1]
        ],
        '5': [
            [1, 1, 1, 1, 1],
            [1],
            [1],
            [, 1, 1, 1],
            [, , , , 1],
            [, , , , 1],
            [1, , , , 1],
            [, 1, 1, 1]
        ],
        '6': [
            [, 1, 1, 1],
            [1 , , , , 1],
            [1],
            [1, 1, 1, 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [, 1, 1, 1]
        ],
        '7': [
            [1, 1, 1, 1, 1],
            [, , , , 1],
            [, , , , 1],
            [, , , 1],
            [, , 1],
            [, , 1],
            [, , 1],
            [, , 1]
        ],
        '8': [
            [, 1, 1, 1],
            [1 , , , , 1],
            [1 , , , , 1],
            [, 1, 1, 1],
            [1, , , , 1],
            [1, , , , 1],
            [1, , , , 1],
            [, 1, 1, 1]
        ],
        '9': [
            [, 1, 1, 1],
            [1 , , , , 1],
            [1 , , , , 1],
            [, 1, 1, 1, 1],
            [, , , , 1],
            [, , , , 1],
            [1, , , , 1],
            [, 1, 1, 1]
        ],
        ' ': [
            [, ,],
            [, ,],
            [, ,],
            [, ,],
            [, ,],
            [, ,],
            [, ,],
            [, ,]
        ],
        ':': [
            [ ,],
            [ ,],
            [1,],
            [ ,],
            [ ,],
            [1,],
            [ ,],
            [ ,]
        ],
        ';': [
            [ ,],
            [ ,],
            [1,],
            [ ,],
            [ ,],
            [1,],
            [1,],
            [ ,]
        ],
        '.': [
            [,],
            [,],
            [,],
            [,],
            [,],
            [,],
            [,],
            [1]
        ],
        ',': [
            [,],
            [,],
            [,],
            [,],
            [,],
            [,],
            [1],
            [1]
        ],
        '?': [
            [, 1, ],
            [1, ,1],
            [, ,1],
            [, ,1],
            [, 1],
            [, 1],
            [],
            [, 1]
        ],
        '!': [
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [],
            [1]
        ],
        '&': [
            [, 1, 1, ],
            [1,, , 1, ],
            [1, , , , ],
            [, 1, , ],
            [1, , 1, , 1],
            [1, , , 1, ],
            [1, , , 1, 1],
            [, 1, 1, ,1]
        ],
        '+': [
            [,],
            [,],
            [, 1],
            [1, 1, 1],
            [, 1],
            [,],
            [,],
            [,]
        ],
        '=': [
            [,],
            [,],
            [1, 1, 1],
            [,],
            [1, 1, 1],
            [,],
            [,],
            [,]
        ],
        '-': [
            [, ,],
            [, ,],
            [, ,],
            [1, 1],
            [, ,],
            [, ,],
            [, ,],
            [, ,]
        ],
        '–': [
            [, ,],
            [, ,],
            [, ,],
            [1, 1, 1],
            [, ,],
            [, ,],
            [, ,],
            [, ,]
        ],
        '(': [
            [, , 1],
            [, 1,],
            [1],
            [1],
            [1],
            [1],
            [, 1],
            [, , 1]
        ],
        ')': [
            [1],
            [, 1,],
            [, ,1],
            [, ,1],
            [, ,1],
            [, ,1],
            [, 1],
            [1]
        ],
        '{': [
            [, , 1],
            [, 1,],
            [, 1],
            [1],
            [, 1],
            [, 1],
            [, 1],
            [, , 1]
        ],
        '}': [
            [1],
            [, 1,],
            [, 1],
            [, ,1],
            [, 1],
            [, 1],
            [, 1],
            [1]
        ],
        '[': [
            [1, 1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1],
            [1, 1]
        ],
        ']': [
            [1, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [, 1],
            [1, 1]
        ],
        '/': [
            [, ,1],
            [, ,1],
            [, ,1],
            [,1],
            [,1],
            [1],
            [1],
            [1]
        ],
        '"': [
            [1, ,1],
            [1, ,1],
            [,],
            [,],
            [,],
            [,],
            [,],
            [,]
        ],
        '\'': [
            [1],
            [1],
            [,],
            [,],
            [,],
            [,],
            [,],
            [,]
        ],
        '$': [
            [, 1],
            [, 1, 1],
            [1, ],
            [, 1, ],
            [, , 1],
            [, , 1],
            [1, 1],
            [, 1]
        ],
        '£': [
            [, , 1, 1],
            [, 1],
            [, 1],
            [, 1, 1],
            [, 1],
            [, 1],
            [, 1],
            [1, 1, 1, 1]
        ],
        '#': [
            [, 1, ,1],
            [, 1, ,1],
            [1, 1, 1, 1, 1],
            [, 1, ,1],
            [, 1, ,1],
            [1, 1, 1, 1, 1],
            [, 1, ,1],
            [, 1, ,1],
        ],
        '@': [
            [, 1, 1, 1, 1, 1],
            [1, , , , , , 1],
            [1, , 1, 1, , , 1],
            [1, , 1, ,1, , 1],
            [1, , 1, 1, 1, 1],
            [1, , , ,, , ],
            [, 1, 1, 1, 1],
            [,]
        ],
        '%': [
            [1, 1, , , 1],
            [1, 1, , ,1],
            [, , ,1],
            [, ,1],
            [, ,1],
            [, 1],
            [1, , , 1, 1],
            [1, , , 1, 1]
        ],
        '*': [
            [,],
            [,],
            [1, , 1, ,1],
            [, 1, 1,1],
            [1, 1,1, 1, 1],
            [, 1, 1,1],
            [1, ,1, , 1],
            [,]
        ],
        '<': [
            [,],
            [, ,1],
            [,1],
            [1],
            [,1],
            [, ,1],
            [,],
            [,]
        ],
        '>': [
            [,],
            [1],
            [,1],
            [, ,1],
            [,1],
            [1],
            [,],
            [,]
        ],
        '<': [
            [,],
            [, ,1],
            [,1],
            [1],
            [,1],
            [, ,1],
            [,],
            [,]
        ],
        '~': [
            [,],
            [,],
            [, 1, ,1],
            [1, ,1],
            [,],
            [,],
            [,],
            [,]
        ],
    };

    let PixelFont = {
        processText (textString) {
            var needed = [];
            var ss = textString.toUpperCase();
            for (var i = 0; i < ss.length; i++) {
                var letter = pixel_font_letters[ss.charAt(i)];
                if (letter) { // There are letters not in the font array.
                    needed.push(letter);
                }
            }
            
            return needed;
        },
        getLetters (textString) {
            var needed = [];
            textString = textString.toUpperCase();
            for (var i = 0; i < textString.length; i++) {
                var letter = pixel_font_letters[textString.charAt(i)];
                if (letter) { // There are letters not in the font array.
                    needed.push(letter);
                }
            }
            return needed;
        },
        generateFullBitmap (needed, fontColor, backgroundColor) {
            let lightsArray = [],
                currX = 0;
            for (let x = 0; x < needed.length; x++) {
                let maxWidth = 0;
                for (let i = 0; i < needed[x].length; i++) {
                    if (!lightsArray[i]) {
                        lightsArray[i] = [];
                    }

                    for (let j = 0; j < needed[x][i].length; j++) {
                        maxWidth = (needed[x][i].length > maxWidth) ? needed[x][i].length : maxWidth;
                        lightsArray[i][j + currX] = (needed[x][i][j]) ? fontColor : backgroundColor;
                    }
                }
                currX += maxWidth + 1;
            }

            return lightsArray;
        },
        generateFrame (fullBitmap, backgroundColor, offset) {
            let lightsArray = new Array();

            fullBitmap.forEach(function (line) {
                // Apply the offset
                if (offset > 0) {
                    Array.prototype.unshift.apply(line, new Array(offset).fill(backgroundColor));
                } else {
                    line = line.splice(offset * (-1), 16)
                }

                // Fill the gaps
                if (line.length < 16) {
                    line = line.concat(new Array(16-line.length).fill(backgroundColor));
                }

                lightsArray = lightsArray.concat(line.splice(0, 16));
            });
            
            // TODO: Refactor this
            for (let i = 0; i < lightsArray.length; i++) {
                if (!lightsArray[i]) {
                    lightsArray[i] = backgroundColor;
                }
            }

            return lightsArray;    
        },
        generateMatrix (textString, fontColor, backgroundColor, offset=0) {
            let needed = this.getLetters(textString),
                fullBitmap = this.generateFullBitmap(needed, fontColor, backgroundColor);
            return this.generateFrame(fullBitmap, backgroundColor, offset);
        },
        generateAnimation (textString, fontColor, backgroundColor) {
            let needed = this.getLetters(textString),
                fullBitmap = this.generateFullBitmap(needed, fontColor, backgroundColor),
                animationFrames = new Array();

            for (let i = 16; i > (fullBitmap[1].length * (-1)) - 16; i--) {
                // Refactor this, we shouldn't recreate the object
                fullBitmap = this.generateFullBitmap(needed, fontColor, backgroundColor)
                animationFrames.push(this.generateFrame(fullBitmap, backgroundColor, i));
            }

            return animationFrames;
        }
    }

    window.Kano.PixelFont = Object.assign({}, PixelFont);;

})(window.Kano = window.Kano || {});
